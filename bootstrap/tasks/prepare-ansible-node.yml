---

# Prepares host for Ansible
# vars: param_delegate_to, param_rootfs

- name: Install packages required by ansible in chroot
  command: chroot {{param_rootfs}} /bin/bash -c "apt-get update -qq && apt-get install -yqq openssh-server sudo python python-apt"
  delegate_to: "{{param_delegate_to}}"

- name: Create admin user in chroot
  command: chroot {{param_rootfs}} /bin/bash -c "groupadd {{ansible_ssh_user}}; useradd {{ansible_ssh_user}} -m -s /bin/bash -g {{ansible_ssh_user}} -G sudo -p '{{ansible_sudo_pass|password_hash('sha512')}}'"
  delegate_to: "{{param_delegate_to}}"

- name: Set authorized key
  authorized_key: user="{{ansible_ssh_user}}" key="{{item}}" path="{{param_rootfs}}/home/{{ansible_ssh_user}}/.ssh/authorized_keys"
  with_file:
    - ~/.ssh/id_rsa.pub
  delegate_to: "{{param_delegate_to}}"

- name: Disallow password authentication
  lineinfile: dest={{param_rootfs}}/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
  delegate_to: "{{param_delegate_to}}"

- name: Disallow root login
  lineinfile: dest={{param_rootfs}}/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
  delegate_to: "{{param_delegate_to}}"

