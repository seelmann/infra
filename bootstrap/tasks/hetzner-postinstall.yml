---

- name: Mount root partition
  mount: name=/mnt src=/dev/vg0/root fstype=ext4 state=mounted

- name: Install packages required by ansible in chroot
  command: chroot /mnt /bin/bash -c "apt-get update -qq && apt-get install -yqq sudo python python-apt"

- name: Create admin user in chroot
  command: chroot /mnt /bin/bash -c "groupadd {{username}}; useradd {{username}} -m -s /bin/bash -g {{username}} -G sudo -p '{{password|password_hash('sha512')}}'"

# Need the admin user in rescue system to make next authorized_key work
- name: Create admin user in rescue system
  user: name="{{username}}"

- name: Set authorized key
  authorized_key: user="{{username}}" key="{{item}}" path="/mnt/home/{{username}}/.ssh/authorized_keys"
  with_file:
    - ~/.ssh/id_rsa.pub

- name: Disallow password authentication
  lineinfile: dest=/mnt/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present

- name: Disallow root login
  lineinfile: dest=/mnt/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present

- name: Unmount root partition
  mount: name=/mnt src=/dev/vg0/root fstype=ext4 state=unmounted

