---

- name: Install network dependencies
  apt: name={{item}} state=present
  with_items:
    - bridge-utils
  when: bridge_device is defined

- name: Copy /etc/resolv.conf
  template: src=resolv.j2 dest=/etc/resolv.conf

- name: Copy /etc/network/interfaces (root)
  template: src=interfaces-root.j2 dest=/etc/network/interfaces
  when: "'rootservers' in group_names"
  notify:
    - Restart networking

- name: Copy /etc/network/interfaces (kvm)
  template: src=interfaces-kvm.j2 dest=/etc/network/interfaces
  when: "'kvm-guests' in group_names"
  notify:
    - Restart networking

- name: Copy /etc/network/interfaces (lxc)
  template: src=interfaces-lxc.j2 dest=/etc/network/interfaces
  when: "'lxc-guests' in group_names"
  notify:
    - Restart networking

- name: Check if bridge exists
  shell: brctl show | grep {{bridge_device}}
  register: brctl_show_result
  failed_when: brctl_show_result.rc != 0 and brctl_show_result.rc != 1
  changed_when: brctl_show_result.rc != 0
  when: bridge_device is defined

- name: Setup bridge
  shell: brctl addbr {{bridge_device}}
  when: bridge_device is defined and brctl_show_result.rc != 0
  notify:
    - Restart networking

- name: Enable IPv6 forwarding
  sysctl: name="net.ipv6.conf.all.forwarding" value=1 sysctl_set=yes
  when: bridge_device is defined

- name: Enable IPv4 forwarding
  sysctl: name="net.ipv4.ip_forward" value=1 sysctl_set=yes
  when: bridge_device is defined

- name: Set Hostname
  hostname: name="{{inventory_hostname}}"
  notify:
    - Restart hostname

- name: Build /etc/hosts file
  lineinfile:
    dest: /etc/hosts
    regexp: "{{item}}.*{{inventory_hostname}}$"
    line: "{{item}} {{inventory_hostname}}.{{network.domain}} {{inventory_hostname}}"
    state: present
  with_items:
    - "{{ipv4_address}}"
    - "{{ipv6_address}}"
  notify:
    - Restart hostname

