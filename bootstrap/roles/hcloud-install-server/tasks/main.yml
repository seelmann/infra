---

# Install Hetzner Cloud server using installimage
# Parameters: param_rootfs, param_mountdev

- name: Run installation
  command: "/root/.oldroot/nfs/install/installimage -a -d sda -r no  -b grub -n {{inventory_hostname}} -p /:ext4:2G,/toberemoved:ext4:all -i /root/images/Debian-93-stretch-64-minimal.tar.gz"
  async: 1200
  poll: 30

- name: Mount root partition
  mount: name={{param_rootfs}} src={{param_mountdev}} fstype=ext4 state=mounted

- name: Remove /toberemoved from /etc/fstab
  lineinfile: dest={{param_rootfs}}/etc/fstab regexp="toberemoved" state=absent

- name: Remove /toberemoved
  file: path={{param_rootfs}}/toberemoved state=absent

- name: Unmount root partition
  mount: name={{param_rootfs}} src={{param_mountdev}} fstype=ext4 state=unmounted

