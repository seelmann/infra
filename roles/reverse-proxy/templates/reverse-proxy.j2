ServerName localhost

<VirtualHost _default_:443>
  #ServerAlias www.foo.com
  DocumentRoot /var/www/html

  #LogLevel info ssl:warn
  LogLevel warn ldap:debug authnz_ldap:debug
  ErrorLog ${APACHE_LOG_DIR}/error.log
  CustomLog ${APACHE_LOG_DIR}/access.log combined

  SSLEngine on
  SSLCertificateFile /etc/ssl/certs/{{inventory_hostname}}.crt
  SSLCertificateKeyFile /etc/ssl/private/{{inventory_hostname}}.key
  SSLProtocol all -SSLv2 -SSLv3
  SSlCipherSuite ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA;
  SSLHonorCipherOrder on

  #ProxyPreserveHost On
  ProxyAddHeaders On
  #RequestHeader unset Authorization
{% for item in reverse_proxy.redirects %}
  Redirect {{item.status}} {{item.path}} {{item.url}}
{% endfor %}
{% for item in reverse_proxy.passes %}
  ProxyPass {{item.path}} {{item.url}}
  ProxyPassReverse {{item.path}} {{item.url}}
{% endfor %}

  <Location />
    SSLRequireSSL

    AuthType Basic
    AuthName "LDAP"
    AuthBasicProvider ldap
    AuthLDAPURL "ldap://{{ldap.host}}:389/{{ldap.baseDN}}?uid?sub?(objectClass=inetOrgPerson)" STARTTLS

{% for item in reverse_proxy.noauths %}
    Require expr %{REQUEST_URI} in { '{{item.path}}' }
{% endfor %}
    Require valid-user
  </Location>

</VirtualHost>

